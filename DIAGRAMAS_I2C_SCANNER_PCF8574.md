# DIAGRAMAS - SISTEMA I2C SCANNER E PCF8574

## 1. ARQUITETURA DO SISTEMA

```
┌─────────────────────────────────────────────────────────────────┐
│                    SISTEMA I2C + PCF8574                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌──────────────┐ │
│  │      ESP32      │    │   I2C BUS       │    │   PCF8574    │ │
│  │                 │    │                 │    │   #1 (0x20)  │ │
│  │ ┌─────────────┐ │    │ ┌─────────────┐ │    │              │ │
│  │ │I2CScanner   │ │    │ │   SDA/SCL   │ │    │ P0 ──► Relé 0│ │
│  │ └─────────────┘ │    │ └─────────────┘ │    │ P1 ──► Relé 1│ │
│  │ ┌─────────────┐ │    │                 │    │ P2 ──► Relé 2│ │
│  │ │RelayCtrl    │ │    │                 │    │ P3 ──► Relé 3│ │
│  │ └─────────────┘ │    │                 │    │ P4 ──► Relé 4│ │
│  │                 │    │                 │    │ P5 ──► Relé 5│ │
│  └─────────────────┘    └─────────────────┘    │ P6 ──► Relé 6│ │
│           │                       │             │ P7 ──► Relé 7│ │
│           └───────────────────────┼─────────────┘              │ │
│                                   │                           │ │
│                                   │                           │ │
│  ┌─────────────────┐    ┌─────────────────┐    ┌──────────────┐ │
│  │   PCF8574       │    │   PCF8574       │    │   PCF8574    │ │
│  │   #2 (0x24)     │    │   #3 (0x21)     │    │   #4 (0x22)  │ │
│  │                 │    │                 │    │              │ │
│  │ P0 ──► Relé 8   │    │ P0 ──► Relé 16  │    │ P0 ──► Relé 24│ │
│  │ P1 ──► Relé 9   │    │ P1 ──► Relé 17  │    │ P1 ──► Relé 25│ │
│  │ P2 ──► Relé 10  │    │ P2 ──► Relé 18  │    │ P2 ──► Relé 26│ │
│  │ P3 ──► Relé 11  │    │ P3 ──► Relé 19  │    │ P3 ──► Relé 27│ │
│  │ P4 ──► Relé 12  │    │ P4 ──► Relé 20  │    │ P4 ──► Relé 28│ │
│  │ P5 ──► Relé 13  │    │ P5 ──► Relé 21  │    │ P5 ──► Relé 29│ │
│  │ P6 ──► Relé 14  │    │ P6 ──► Relé 22  │    │ P6 ──► Relé 30│ │
│  │ P7 ──► Relé 15  │    │ P7 ──► Relé 23  │    │ P7 ──► Relé 31│ │
│  └─────────────────┘    └─────────────────┘    └──────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## 2. FLUXO DE DETECÇÃO I2C

```
┌─────────────────────────────────────────────────────────────────┐
│                    I2C SCANNER FLOW                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐                                           │
│  │   START SCAN    │                                           │
│  └─────────┬───────┘                                           │
│            │                                                    │
│            ▼                                                    │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │              SCAN ALL ADDRESSES (1-127)                    │ │
│  │                                                             │ │
│  │  for (address = 1; address < 127; address++) {             │ │
│  │    Wire.beginTransmission(address);                        │ │
│  │    error = Wire.endTransmission();                         │ │
│  │    if (error == 0) {                                       │ │
│  │      // Device found!                                      │ │
│  │      addDeviceToList(address);                             │ │
│  │    }                                                        │ │
│  │  }                                                          │ │
│  └─────────────────────────────────────────────────────────────┘ │
│            │                                                    │
│            ▼                                                    │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │              FILTER PCF8574 DEVICES                       │ │
│  │                                                             │ │
│  │  for (address = 0x20; address <= 0x27; address++) {       │ │
│  │    if (testAddress(address)) {                              │ │
│  │      pcfList.push_back(address);                           │ │
│  │    }                                                        │ │
│  │  }                                                          │ │
│  └─────────────────────────────────────────────────────────────┘ │
│            │                                                    │
│            ▼                                                    │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │              INITIALIZE RELAY CONTROLLER                  │ │
│  │                                                             │ │
│  │  for (each PCF8574 found) {                                │ │
│  │    pcf.begin(address);                                     │ │
│  │    if (pcf.connected()) {                                  │ │
│  │      // Initialize relays                                   │ │
│  │      for (pin = 0; pin < 8; pin++) {                      │ │
│  │        pcf.write(pin, HIGH); // Turn off relay             │ │
│  │      }                                                      │ │
│  │    }                                                        │ │
│  │  }                                                          │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## 3. MAPEAMENTO DE RELÉS

```
┌─────────────────────────────────────────────────────────────────┐
│                    RELAY MAPPING SYSTEM                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌──────────────┐ │
│  │   PCF8574 #1    │    │   PCF8574 #2    │    │   PCF8574 #3 │ │
│  │   Address: 0x20 │    │   Address: 0x24 │    │   Address: 0x21│ │
│  │                 │    │                 │    │              │ │
│  │ P0 ──► Relé 0   │    │ P0 ──► Relé 8   │    │ P0 ──► Relé 16│ │
│  │ P1 ──► Relé 1   │    │ P1 ──► Relé 9   │    │ P1 ──► Relé 17│ │
│  │ P2 ──► Relé 2   │    │ P2 ──► Relé 10  │    │ P2 ──► Relé 18│ │
│  │ P3 ──► Relé 3   │    │ P3 ──► Relé 11  │    │ P3 ──► Relé 19│ │
│  │ P4 ──► Relé 4   │    │ P4 ──► Relé 12  │    │ P4 ──► Relé 20│ │
│  │ P5 ──► Relé 5   │    │ P5 ──► Relé 13  │    │ P5 ──► Relé 21│ │
│  │ P6 ──► Relé 6   │    │ P6 ──► Relé 14  │    │ P6 ──► Relé 22│ │
│  │ P7 ──► Relé 7   │    │ P7 ──► Relé 15  │    │ P7 ──► Relé 23│ │
│  └─────────────────┘    └─────────────────┘    └──────────────┘ │
│           │                       │                       │     │
│           ▼                       ▼                       ▼     │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │              RELAY CONTROLLER LOGIC                        │ │
│  │                                                             │ │
│  │  writeToRelay(relayNumber, state) {                        │ │
│  │    if (relayNumber < 8) {                                  │ │
│  │      pcf1.write(relayNumber, !state);                      │ │
│  │    } else if (relayNumber < 16) {                          │ │
│  │      pcf2.write(relayNumber - 8, !state);                  │ │
│  │    } else if (relayNumber < 24) {                          │ │
│  │      pcf3.write(relayNumber - 16, !state);                 │ │
│  │    }                                                        │ │
│  │  }                                                          │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## 4. CONFIGURAÇÃO DE ENDEREÇOS PCF8574

```
┌─────────────────────────────────────────────────────────────────┐
│                    PCF8574 ADDRESS CONFIGURATION               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌──────────────┐ │
│  │   PCF8574       │    │   PCF8574       │    │   PCF8574    │ │
│  │   Address: 0x20 │    │   Address: 0x24 │    │   Address: 0x21│ │
│  │                 │    │                 │    │              │ │
│  │ A2 ──► GND      │    │ A2 ──► VCC      │    │ A2 ──► GND   │ │
│  │ A1 ──► GND      │    │ A1 ──► GND      │    │ A1 ──► GND   │ │
│  │ A0 ──► GND      │    │ A0 ──► GND      │    │ A0 ──► VCC   │ │
│  │                 │    │                 │    │              │ │
│  │ Binary: 000     │    │ Binary: 100     │    │ Binary: 001  │ │
│  │ Hex: 0x20      │    │ Hex: 0x24       │    │ Hex: 0x21   │ │
│  └─────────────────┘    └─────────────────┘    └──────────────┘ │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │              ADDRESS CONFIGURATION TABLE                   │ │
│  │                                                             │ │
│  │ A2 A1 A0 | Binary | Hex | Configuration                    │ │
│  │ ---------|--------|-----|----------------------------------│ │
│  │ 0  0  0  |  000   | 0x20| A0=GND, A1=GND, A2=GND          │ │
│  │ 0  0  1  |  001   | 0x21| A0=VCC, A1=GND, A2=GND          │ │
│  │ 0  1  0  |  010   | 0x22| A0=GND, A1=VCC, A2=GND          │ │
│  │ 0  1  1  |  011   | 0x23| A0=VCC, A1=VCC, A2=GND          │ │
│  │ 1  0  0  |  100   | 0x24| A0=GND, A1=GND, A2=VCC          │ │
│  │ 1  0  1  |  101   | 0x25| A0=VCC, A1=GND, A2=VCC          │ │
│  │ 1  1  0  |  110   | 0x26| A0=GND, A1=VCC, A2=VCC          │ │
│  │ 1  1  1  |  111   | 0x27| A0=VCC, A1=VCC, A2=VCC          │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## 5. SISTEMA DE DIAGNÓSTICO

```
┌─────────────────────────────────────────────────────────────────┐
│                    DIAGNOSTIC SYSTEM                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌──────────────┐ │
│  │   I2C SCAN      │    │   PCF8574       │    │   RELAY      │ │
│  │   DIAGNOSTIC    │    │   DIAGNOSTIC    │    │   DIAGNOSTIC │ │
│  │                 │    │                 │    │              │ │
│  │ • Scan all      │    │ • Test address  │    │ • Test each  │ │
│  │   addresses     │    │ • Check response│    │   relay      │ │
│  │ • Find devices  │    │ • Verify pins   │    │ • Check state│ │
│  │ • Identify type │    │ • Test I/O      │    │ • Verify     │ │
│  │                 │    │                 │    │   control    │ │
│  └─────────────────┘    └─────────────────┘    └──────────────┘ │
│           │                       │                       │     │
│           └───────────────────────┼───────────────────────┘     │
│                                   ▼                           │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │              DIAGNOSTIC RESULTS                            │ │
│  │                                                             │ │
│  │  I2C Devices Found: 3                                      │ │
│  │  ├─ 0x20 (PCF8574) ✅                                      │ │
│  │  ├─ 0x24 (PCF8574) ✅                                      │ │
│  │  └─ 0x27 (LCD I2C) ✅                                      │ │
│  │                                                             │ │
│  │  PCF8574 Status:                                            │ │
│  │  ├─ PCF1 (0x20): Online ✅                                   │ │
│  │  └─ PCF2 (0x24): Online ✅                                 │ │
│  │                                                             │ │
│  │  Relay Status:                                              │ │
│  │  ├─ Relés 0-7:  ✅ (PCF1)                                  │ │
│  │  └─ Relés 8-15: ✅ (PCF2)                                  │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## 6. FLUXO DE CONTROLE DE RELÉS

```
┌─────────────────────────────────────────────────────────────────┐
│                    RELAY CONTROL FLOW                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐                                           │
│  │   COMMAND      │                                           │
│  │   setRelay(5, true)                                        │
│  └─────────┬───────┘                                           │
│            │                                                    │
│            ▼                                                    │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │              VALIDATE RELAY NUMBER                         │ │
│  │                                                             │ │
│  │  if (relayNumber < 0 || relayNumber >= 16) {              │ │
│  │    return ERROR;                                           │ │
│  │  }                                                          │ │
│  └─────────────────────────────────────────────────────────────┘ │
│            │                                                    │
│            ▼                                                    │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │              DETERMINE PCF8574                            │ │
│  │                                                             │ │
│  │  if (relayNumber < 8) {                                    │ │
│  │    pcf = &pcf1;  // PCF8574 #1 (0x20)                     │ │
│  │    pin = relayNumber;                                      │ │
│  │  } else {                                                   │ │
│  │    pcf = &pcf2;  // PCF8574 #2 (0x24)                     │ │
│  │    pin = relayNumber - 8;                                  │ │
│  │  }                                                          │ │
│  └─────────────────────────────────────────────────────────────┘ │
│            │                                                    │
│            ▼                                                    │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │              CHECK PCF8574 STATUS                          │ │
│  │                                                             │ │
│  │  if (!pcf->isConnected()) {                                │ │
│  │    return ERROR;                                           │ │
│  │  }                                                          │ │
│  └─────────────────────────────────────────────────────────────┘ │
│            │                                                    │
│            ▼                                                    │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │              WRITE TO HARDWARE                             │ │
│  │                                                             │ │
│  │  // PCF8574 uses inverted logic                             │ │
│  │  pcf->write(pin, !state);                                   │ │
│  │                                                             │ │
│  │  // Update internal state                                   │ │
│  │  relayStates[relayNumber].isOn = state;                    │ │
│  │  relayStates[relayNumber].startTime = millis();            │ │
│  └─────────────────────────────────────────────────────────────┘ │
│            │                                                    │
│            ▼                                                    │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │              CALLBACK NOTIFICATION                         │ │
│  │                                                             │ │
│  │  if (stateChangeCallback) {                                │ │
│  │    stateChangeCallback(relayNumber, state, 0);              │ │
│  │  }                                                          │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## 7. SISTEMA DE TIMERS

```
┌─────────────────────────────────────────────────────────────────┐
│                    RELAY TIMER SYSTEM                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌──────────────┐ │
│  │   RELAY 0       │    │   RELAY 1       │    │   RELAY 2    │ │
│  │                 │    │                 │    │              │ │
│  │ Timer: 30s      │    │ Timer: 0s      │    │ Timer: 60s   │ │
│  │ State: ON       │    │ State: OFF     │    │ State: ON    │ │
│  │ Remaining: 15s  │    │ Remaining: 0s  │    │ Remaining: 45s│ │
│  └─────────────────┘    └─────────────────┘    └──────────────┘ │
│           │                       │                       │     │
│           ▼                       ▼                       ▼     │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │              TIMER CHECKER (update())                     │ │
│  │                                                             │ │
│  │  for (int i = 0; i < NUM_RELAYS; i++) {                   │ │
│  │    if (relayStates[i].hasTimer) {                          │ │
│  │      if (millis() - startTime >= timerSeconds * 1000) {    │ │
│  │        setRelay(i, false);  // Auto turn off               │ │
│  │        relayStates[i].hasTimer = false;                   │ │
│  │      }                                                      │ │
│  │    }                                                        │ │
│  │  }                                                          │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## 8. CONFIGURAÇÃO DE MÚLTIPLOS PCF8574

```
┌─────────────────────────────────────────────────────────────────┐
│                MULTIPLE PCF8574 CONFIGURATION                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐                                           │
│  │      ESP32      │                                           │
│  │                 │                                           │
│  │  ┌─────────────┐│    ┌─────────────────┐                   │
│  │  │   I2C BUS   ││    │   PCF8574 #1    │                   │
│  │  │             ││    │   Address: 0x20 │                   │
│  │  │ SDA ────────┼┼────┼─► SDA           │                   │
│  │  │ SCL ────────┼┼────┼─► SCL           │                   │
│  │  │ 3.3V ───────┼┼────┼─► VCC           │                   │
│  │  │ GND ────────┼┼────┼─► GND           │                   │
│  │  └─────────────┘│    └─────────────────┘                   │
│  │                 │           │                             │
│  │                 │           ▼                             │
│  │                 │    ┌─────────────────┐                   │
│  │                 │    │   PCF8574 #2    │                   │
│  │                 │    │   Address: 0x24 │                   │
│  │                 │    │                 │                   │
│  │                 │    │ SDA ◄──────────┼┼──────────────────┘
│  │                 │    │ SCL ◄──────────┼┼──────────────────┘
│  │                 │    │ VCC ◄──────────┼┼──────────────────┘
│  │                 │    │ GND ◄──────────┼┼──────────────────┘
│  │                 │    └─────────────────┘                   │
│  │                 │           │                             │
│  │                 │           ▼                             │
│  │                 │    ┌─────────────────┐                   │
│  │                 │    │   PCF8574 #3    │                   │
│  │                 │    │   Address: 0x21 │                   │
│  │                 │    │                 │                   │
│  │                 │    │ SDA ◄──────────┼┼──────────────────┘
│  │                 │    │ SCL ◄──────────┼┼──────────────────┘
│  │                 │    │ VCC ◄──────────┼┼──────────────────┘
│  │                 │    │ GND ◄──────────┼┼──────────────────┘
│  │                 │    └─────────────────┘                   │
│  └─────────────────┘                                           │
└─────────────────────────────────────────────────────────────────┘
```

## 9. SISTEMA DE BACKUP E REDUNDÂNCIA

```
┌─────────────────────────────────────────────────────────────────┐
│                    BACKUP SYSTEM                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌──────────────┐ │
│  │   PRIMARY       │    │   BACKUP        │    │   MONITOR    │ │
│  │   PCF8574       │    │   PCF8574       │    │   SYSTEM     │ │
│  │   (0x20)        │    │   (0x21)        │    │              │ │
│  │                 │    │                 │    │              │ │
│  │ P0 ──► Relé 0   │    │ P0 ──► Relé 0   │    │ • Health     │ │
│  │ P1 ──► Relé 1   │    │ P1 ──► Relé 1   │    │   Check      │ │
│  │ P2 ──► Relé 2   │    │ P2 ──► Relé 2   │    │ • Failover   │ │
│  │ P3 ──► Relé 3   │    │ P3 ──► Relé 3   │    │ • Recovery   │ │
│  │ P4 ──► Relé 4   │    │ P4 ──► Relé 4   │    │              │ │
│  │ P5 ──► Relé 5   │    │ P5 ──► Relé 5   │    │              │ │
│  │ P6 ──► Relé 6   │    │ P6 ──► Relé 6   │    │              │ │
│  │ P7 ──► Relé 7   │    │ P7 ──► Relé 7   │    │              │ │
│  └─────────────────┘    └─────────────────┘    └──────────────┘ │
│           │                       │                       │     │
│           └───────────────────────┼───────────────────────┘     │
│                                   ▼                           │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │              FAILOVER LOGIC                                │ │
│  │                                                             │ │
│  │  writeToRelayWithBackup(relay, state) {                    │ │
│  │    if (primaryPCF.isConnected()) {                         │ │
│  │      primaryPCF.write(relay, !state);                       │ │
│  │      backupPCF.write(relay, !state);  // Mirror            │ │
│  │    } else {                                                 │ │
│  │      backupPCF.write(relay, !state);  // Failover          │ │
│  │    }                                                        │ │
│  │  }                                                          │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## 10. MONITORAMENTO E STATUS

```
┌─────────────────────────────────────────────────────────────────┐
│                    MONITORING SYSTEM                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌──────────────┐ │
│  │   I2C STATUS    │    │   PCF8574       │    │   RELAY      │ │
│  │   MONITOR       │    │   STATUS        │    │   STATUS     │ │
│  │                 │    │   MONITOR       │    │   MONITOR    │ │
│  │ • Scan results  │    │ • Connection    │    │ • State      │ │
│  │ • Device count  │    │ • Response time │    │ • Timer      │ │
│  │ • Error rate    │    │ • Error count   │    │ • Health     │ │
│  │                 │    │                 │    │              │ │
│  └─────────────────┘    └─────────────────┘    └──────────────┘ │
│           │                       │                       │     │
│           └───────────────────────┼───────────────────────┘     │
│                                   ▼                           │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │              STATUS DASHBOARD                              │ │
│  │                                                             │ │
│  │  I2C Bus Status: ✅ Healthy                                │ │
│  │  ├─ Devices: 3                                            │
│  │  ├─ Scan Time: 45ms                                    │ │
│  │  └─ Error Rate: 0.1%                                   │ │
│  │                                                             │ │
│  │  PCF8574 Status:                                         │ │
│  │  ├─ PCF1 (0x20): ✅ Online (RSSI: -45dBm)              │ │
│  │  ├─ PCF2 (0x24): ✅ Online (RSSI: -42dBm)              │ │
│  │  └─ PCF3 (0x21): ❌ Offline (Last seen: 2m ago)        │ │
│  │                                                             │ │
│  │  Relay Status:                                             │ │
│  │  ├─ Active: 8/16                                          │ │
│  │  ├─ With Timer: 3                                         │ │
│  │  └─ Errors: 0                                             │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

Estes diagramas fornecem uma visão completa do sistema I2C Scanner e PCF8574, incluindo arquitetura, fluxos de detecção, mapeamento de relés e sistemas de monitoramento.

